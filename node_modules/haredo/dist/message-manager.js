"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeMessageManager = exports.MessageManagerEvents = void 0;
const events_1 = require("./events");
const utils_1 = require("./utils");
var MessageManagerEvents;
(function (MessageManagerEvents) {
    MessageManagerEvents["MESSAGE_MANAGER_DRAINED"] = "drained";
})(MessageManagerEvents = exports.MessageManagerEvents || (exports.MessageManagerEvents = {}));
exports.makeMessageManager = (logger) => {
    let messages = [];
    const length = () => messages.length;
    const isDrained = () => length() === 0;
    const add = (message) => {
        messages = messages.concat(message);
        message.emitter.once('handled', () => {
            remove(message);
        });
    };
    const remove = (message) => {
        messages = messages.filter(x => x !== message);
    };
    const drain = async () => {
        logger.info({ component: 'MessageManager', msg: 'Draining' });
        if (!isDrained()) {
            await utils_1.promiseMap(messages, async ({ isHandled, emitter }) => {
                /* istanbul ignore if */
                if (isHandled()) {
                    return;
                }
                await events_1.typedEventToPromise(emitter, 'handled');
            });
        }
        logger.info({ component: 'MessageManager', msg: 'No messages left, done' });
    };
    return {
        length,
        isDrained,
        add,
        remove,
        drain
    };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVzc2FnZS1tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL21lc3NhZ2UtbWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxxQ0FBK0M7QUFDL0MsbUNBQXFDO0FBR3JDLElBQVksb0JBRVg7QUFGRCxXQUFZLG9CQUFvQjtJQUM1QiwyREFBbUMsQ0FBQTtBQUN2QyxDQUFDLEVBRlcsb0JBQW9CLEdBQXBCLDRCQUFvQixLQUFwQiw0QkFBb0IsUUFFL0I7QUFFWSxRQUFBLGtCQUFrQixHQUFHLENBQUMsTUFBZSxFQUFFLEVBQUU7SUFDbEQsSUFBSSxRQUFRLEdBQW9CLEVBQUUsQ0FBQztJQUNuQyxNQUFNLE1BQU0sR0FBRyxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDO0lBQ3JDLE1BQU0sU0FBUyxHQUFHLEdBQUcsRUFBRSxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztJQUN2QyxNQUFNLEdBQUcsR0FBRyxDQUFDLE9BQXNCLEVBQUUsRUFBRTtRQUNuQyxRQUFRLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNwQyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsR0FBRyxFQUFFO1lBQ2pDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNwQixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQztJQUNGLE1BQU0sTUFBTSxHQUFHLENBQUMsT0FBc0IsRUFBRSxFQUFFO1FBQ3RDLFFBQVEsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLE9BQU8sQ0FBQyxDQUFDO0lBQ25ELENBQUMsQ0FBQztJQUNGLE1BQU0sS0FBSyxHQUFHLEtBQUssSUFBSSxFQUFFO1FBQ3JCLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUM7UUFDOUQsSUFBSSxDQUFDLFNBQVMsRUFBRSxFQUFFO1lBQ2QsTUFBTSxrQkFBVSxDQUFDLFFBQVEsRUFBRSxLQUFLLEVBQUUsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRTtnQkFDeEQsd0JBQXdCO2dCQUN4QixJQUFJLFNBQVMsRUFBRSxFQUFFO29CQUNiLE9BQU87aUJBQ1Y7Z0JBQ0QsTUFBTSw0QkFBbUIsQ0FBQyxPQUFPLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFDbEQsQ0FBQyxDQUFDLENBQUM7U0FDTjtRQUNELE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFLHdCQUF3QixFQUFFLENBQUMsQ0FBQztJQUNoRixDQUFDLENBQUM7SUFDRixPQUFPO1FBQ0gsTUFBTTtRQUNOLFNBQVM7UUFDVCxHQUFHO1FBQ0gsTUFBTTtRQUNOLEtBQUs7S0FDUixDQUFDO0FBQ04sQ0FBQyxDQUFDIn0=