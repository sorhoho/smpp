"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.main = void 0;
const __1 = require("..");
const utils_1 = require("../utils");
exports.main = async () => {
    const rabbit = __1.haredo({
        connection: 'amqp://guest:guest@localhost:5672/'
    });
    const queue = __1.q('factorial');
    await rabbit
        .queue(queue)
        .autoReply()
        .use(logMessage)
        .use(logReply)
        .subscribe(({ data }) => {
        return factorial(data);
    });
    while (true) {
        await rabbit.queue(queue).rpc(randomBetween(1, 30), { appId: 'Middleware-example' });
        await utils_1.delay(1000);
    }
};
const logMessage = ({ appId }) => {
    console.log('Received a message from', appId);
    // next will be called automatically if it's not done from inside the middleware
    // and middleware doesn't ack/nack the message`
};
const logReply = async ({ queue, getReply, data }, next) => {
    const start = Date.now();
    await next();
    console.log(queue, data, 'response', getReply(), 'took', `${Date.now() - start}ms`);
};
const randomBetween = (min, max) => {
    return Math.floor(Math.random() * (max - min + 1)) + min;
};
const factorial = (num) => {
    if (num < 0) {
        return -1;
    }
    if (num === 0) {
        return 1;
    }
    return num * factorial(num - 1);
};
process.nextTick(exports.main);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWlkZGxld2FyZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9leGFtcGxlcy9taWRkbGV3YXJlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDBCQUEyQztBQUMzQyxvQ0FBaUM7QUFFcEIsUUFBQSxJQUFJLEdBQUcsS0FBSyxJQUFJLEVBQUU7SUFDM0IsTUFBTSxNQUFNLEdBQUcsVUFBTSxDQUFDO1FBQ2xCLFVBQVUsRUFBRSxvQ0FBb0M7S0FDbkQsQ0FBQyxDQUFDO0lBQ0gsTUFBTSxLQUFLLEdBQUcsS0FBQyxDQUFpQixXQUFXLENBQUMsQ0FBQztJQUU3QyxNQUFNLE1BQU07U0FDUCxLQUFLLENBQUMsS0FBSyxDQUFDO1NBQ1osU0FBUyxFQUFFO1NBQ1gsR0FBRyxDQUFDLFVBQVUsQ0FBQztTQUNmLEdBQUcsQ0FBQyxRQUFRLENBQUM7U0FDYixTQUFTLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUU7UUFDcEIsT0FBTyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDM0IsQ0FBQyxDQUFDLENBQUM7SUFFUCxPQUFPLElBQUksRUFBRTtRQUNULE1BQU0sTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxvQkFBb0IsRUFBRSxDQUFDLENBQUM7UUFDckYsTUFBTSxhQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDckI7QUFDTCxDQUFDLENBQUM7QUFFRixNQUFNLFVBQVUsR0FBZSxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRTtJQUN6QyxPQUFPLENBQUMsR0FBRyxDQUFDLHlCQUF5QixFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQzlDLGdGQUFnRjtJQUNoRiwrQ0FBK0M7QUFDbkQsQ0FBQyxDQUFDO0FBRUYsTUFBTSxRQUFRLEdBQWUsS0FBSyxFQUFFLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFBRTtJQUNuRSxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDekIsTUFBTSxJQUFJLEVBQUUsQ0FBQztJQUNiLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLEVBQUUsTUFBTSxFQUFFLEdBQUksSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLEtBQU0sSUFBSSxDQUFDLENBQUM7QUFDMUYsQ0FBQyxDQUFDO0FBRUYsTUFBTSxhQUFhLEdBQUcsQ0FBQyxHQUFXLEVBQUUsR0FBVyxFQUFFLEVBQUU7SUFDL0MsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUM7QUFDN0QsQ0FBQyxDQUFDO0FBRUYsTUFBTSxTQUFTLEdBQUcsQ0FBQyxHQUFXLEVBQVUsRUFBRTtJQUN0QyxJQUFJLEdBQUcsR0FBRyxDQUFDLEVBQUU7UUFDVCxPQUFPLENBQUMsQ0FBQyxDQUFDO0tBQ2I7SUFDRCxJQUFJLEdBQUcsS0FBSyxDQUFDLEVBQUU7UUFDWCxPQUFPLENBQUMsQ0FBQztLQUNaO0lBQ0QsT0FBTyxHQUFHLEdBQUcsU0FBUyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUNwQyxDQUFDLENBQUM7QUFFRixPQUFPLENBQUMsUUFBUSxDQUFDLFlBQUksQ0FBQyxDQUFDIn0=