"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.standardBackoff = void 0;
const utils_1 = require("./utils");
const standardBackoffDefaults = {
    failThreshold: 3,
    failSpan: 5000,
    failTimeout: 5000
};
exports.standardBackoff = ({ failThreshold = standardBackoffDefaults.failThreshold, failSpan = standardBackoffDefaults.failSpan, failTimeout = standardBackoffDefaults.failTimeout } = {}) => {
    let errors = [];
    let timeout;
    return {
        nack: (requeue) => {
            if (requeue) {
                const error = new Date();
                errors = errors.concat(error);
                if (errors.length >= failThreshold) {
                    timeout = utils_1.delay(failTimeout);
                }
                setTimeout(() => { errors = errors.filter(x => x !== error); }, failSpan);
            }
        },
        take: async () => {
            await timeout;
        }
    };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFja29mZnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvYmFja29mZnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsbUNBQWdDO0FBOENoQyxNQUFNLHVCQUF1QixHQUEyQjtJQUNwRCxhQUFhLEVBQUUsQ0FBQztJQUNoQixRQUFRLEVBQUUsSUFBSTtJQUNkLFdBQVcsRUFBRSxJQUFJO0NBQ3BCLENBQUM7QUFFVyxRQUFBLGVBQWUsR0FBRyxDQUMzQixFQUNJLGFBQWEsR0FBRyx1QkFBdUIsQ0FBQyxhQUFhLEVBQ3JELFFBQVEsR0FBRyx1QkFBdUIsQ0FBQyxRQUFRLEVBQzNDLFdBQVcsR0FBRyx1QkFBdUIsQ0FBQyxXQUFXLEtBQ2hCLEVBQUUsRUFDekIsRUFBRTtJQUNoQixJQUFJLE1BQU0sR0FBRyxFQUFZLENBQUM7SUFDMUIsSUFBSSxPQUFzQixDQUFDO0lBQzNCLE9BQU87UUFDSCxJQUFJLEVBQUUsQ0FBQyxPQUFPLEVBQUUsRUFBRTtZQUNkLElBQUksT0FBTyxFQUFFO2dCQUNULE1BQU0sS0FBSyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7Z0JBQ3pCLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUM5QixJQUFJLE1BQU0sQ0FBQyxNQUFNLElBQUksYUFBYSxFQUFFO29CQUNoQyxPQUFPLEdBQUcsYUFBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO2lCQUNoQztnQkFDRCxVQUFVLENBQUMsR0FBRyxFQUFFLEdBQUcsTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUM7YUFDN0U7UUFDTCxDQUFDO1FBQ0QsSUFBSSxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ2IsTUFBTSxPQUFPLENBQUM7UUFDbEIsQ0FBQztLQUNKLENBQUM7QUFDTixDQUFDLENBQUMifQ==